<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>London Postcode Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #map { height: 100%; width: 100%; }

  .info-panel {
    position: absolute; top: 10px; right: 10px; z-index: 1000;
    background: white; padding: 12px 16px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 220px;
    font-size: 14px;
  }
  .info-panel h3 { margin: 0 0 2px 0; font-size: 20px; }
  .info-panel .detail { color: #666; font-size: 12px; margin: 1px 0; }
  .search-box {
    position: absolute; top: 10px; left: 55px; z-index: 1000;
  }
  .search-box input {
    padding: 8px 12px; border: 2px solid #ccc; border-radius: 6px;
    font-size: 14px; width: 220px; outline: none;
  }
  .search-box input:focus { border-color: #3498db; }

  .area-panel {
    position: absolute; top: 55px; left: 10px; z-index: 1000;
    background: white; padding: 10px 14px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px;
    max-height: calc(100vh - 100px); overflow-y: auto;
    width: 170px;
  }
  .area-panel h4 { margin: 0 0 8px 0; font-size: 13px; }
  .area-item {
    display: flex; align-items: center; margin: 3px 0; cursor: pointer;
    padding: 2px 4px; border-radius: 4px;
  }
  .area-item:hover { background: #f0f0f0; }
  .area-item input { margin-right: 6px; cursor: pointer; }
  .area-item .color-dot {
    width: 12px; height: 12px; border-radius: 3px; margin-right: 6px;
    border: 1px solid rgba(0,0,0,0.15); flex-shrink: 0;
  }
  .area-item label { cursor: pointer; flex: 1; }
  .area-item .count { color: #999; font-size: 10px; margin-left: 4px; }

  .loading-indicator {
    position: absolute; bottom: 30px; right: 10px; z-index: 1000;
    background: white; padding: 6px 12px; border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-size: 12px;
    display: none;
  }
  .loading-indicator.active { display: block; }

  .stats {
    position: absolute; bottom: 30px; left: 10px; z-index: 1000;
    background: white; padding: 8px 12px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 11px;
    line-height: 1.5;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  <input type="text" id="search" placeholder="Search postcode (e.g. E17 9PB)">
</div>

<div class="info-panel" id="info">
  <h3 id="info-postcode">London Postcode Map</h3>
  <div class="detail" id="info-detail">Hover over a postcode unit</div>
  <div class="detail" id="info-district"></div>
</div>

<div class="area-panel" id="area-panel">
  <h4>Postcode Areas</h4>
  <div id="area-list"></div>
</div>

<div class="loading-indicator" id="loading">Loading...</div>

<div class="stats" id="stats">
  <div>205,191 postcode units</div>
  <div id="stats-loaded">Loaded: 0 districts</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const AREA_COLORS = {
  'E':  '#3498db', 'EC': '#2980b9',
  'N':  '#2ecc71', 'NW': '#27ae60',
  'SE': '#e74c3c', 'SW': '#c0392b',
  'W':  '#f39c12', 'WC': '#e67e22',
  'BR': '#8e44ad', 'CR': '#9b59b6',
  'DA': '#1abc9c', 'EN': '#16a085',
  'HA': '#d35400', 'IG': '#2c3e50',
  'KT': '#7f8c8d', 'RM': '#34495e',
  'SM': '#e84393', 'TW': '#00b894',
  'UB': '#6c5ce7'
};

function sectorShade(hexColor, sectorDigit) {
  const d = parseInt(sectorDigit) || 0;
  const factor = 0.7 + (d / 9) * 0.5;
  const r = parseInt(hexColor.slice(1,3), 16);
  const g = parseInt(hexColor.slice(3,5), 16);
  const b = parseInt(hexColor.slice(5,7), 16);
  const clamp = v => Math.min(255, Math.max(0, Math.round(v * factor)));
  return `rgb(${clamp(r)},${clamp(g)},${clamp(b)})`;
}

const canvasRenderer = L.canvas({ padding: 0.5 });
const map = L.map('map', { zoomControl: true, renderer: canvasRenderer, preferCanvas: true }).setView([51.505, -0.09], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors | Postcode data: OGL v3.0',
  maxZoom: 19
}).addTo(map);

let manifest = {};
let loadedDistricts = {};   // district -> L.geoJSON layer
let loadingDistricts = {};  // district -> Promise
let allFeatureLookup = {};  // postcode (no spaces, uppercase) -> { feature, layer }
let enabledAreas = new Set();
let highlightedLayer = null;
let loadedCount = 0;

const loadingEl = document.getElementById('loading');
const statsLoadedEl = document.getElementById('stats-loaded');

function getArea(postcode) {
  const m = postcode.match(/^([A-Z]{1,2})/);
  return m ? m[1] : '?';
}

function getSector(postcode) {
  const parts = postcode.split(' ');
  return parts.length === 2 ? parts[1][0] : '0';
}

function defaultStyle(feature) {
  const pc = feature.properties.postcodes || '';
  const area = getArea(pc);
  const sector = getSector(pc);
  const baseColor = AREA_COLORS[area] || '#95a5a6';
  return {
    fillColor: sectorShade(baseColor, sector),
    weight: 1,
    opacity: 1,
    color: 'rgba(255,255,255,0.7)',
    fillOpacity: 0.55
  };
}

function highlightStyle() {
  return { weight: 2.5, color: '#2c3e50', fillOpacity: 0.7 };
}

function onEachFeature(feature, layer) {
  const pc = feature.properties.postcodes || '';
  allFeatureLookup[pc.toUpperCase().replace(/\s/g, '')] = { feature, layer };

  layer.on({
    mouseover: function(e) {
      e.target.setStyle(highlightStyle());
      e.target.bringToFront();
      const district = pc.split(' ')[0];
      document.getElementById('info-postcode').innerHTML =
        pc;
      document.getElementById('info-detail').textContent = 'Area: ' + getArea(pc);
      document.getElementById('info-district').textContent = 'District: ' + district;
    },
    mouseout: function(e) {
      const d = e.target.feature.properties.postcodes.split(' ')[0];
      if (loadedDistricts[d]) loadedDistricts[d].resetStyle(e.target);
    },
    click: function(e) {
      map.fitBounds(e.target.getBounds(), { maxZoom: 18, padding: [50, 50] });
    }
  });
}

function loadDistrict(district) {
  if (loadedDistricts[district]) {
    // Already loaded, just make sure it's on the map
    if (!map.hasLayer(loadedDistricts[district])) {
      loadedDistricts[district].addTo(map);
    }
    return Promise.resolve();
  }
  if (loadingDistricts[district]) return loadingDistricts[district];

  const entry = manifest[district];
  if (!entry) return Promise.resolve();

  loadingDistricts[district] = fetch('data/' + entry.file)
    .then(r => r.json())
    .then(data => {
      const layer = L.geoJSON(data, {
        style: defaultStyle,
        onEachFeature: onEachFeature
      }).addTo(map);
      loadedDistricts[district] = layer;
      loadedCount++;
      statsLoadedEl.textContent = 'Loaded: ' + loadedCount + ' districts';
      delete loadingDistricts[district];
    })
    .catch(err => {
      console.error('Failed to load ' + district, err);
      delete loadingDistricts[district];
    });

  return loadingDistricts[district];
}

function unloadDistrict(district) {
  if (!loadedDistricts[district]) return;
  map.removeLayer(loadedDistricts[district]);
  loadedDistricts[district].eachLayer(l => {
    const pc = l.feature.properties.postcodes;
    if (pc) delete allFeatureLookup[pc.toUpperCase().replace(/\s/g, '')];
  });
  delete loadedDistricts[district];
  loadedCount--;
  statsLoadedEl.textContent = 'Loaded: ' + loadedCount + ' districts';
}

function getDistrictsForArea(area) {
  return Object.keys(manifest).filter(d => manifest[d].area === area);
}

async function toggleArea(area, enabled) {
  const districts = getDistrictsForArea(area);

  if (enabled) {
    enabledAreas.add(area);
    loadingEl.classList.add('active');
    // Load in batches of 5
    for (let i = 0; i < districts.length; i += 5) {
      const batch = districts.slice(i, i + 5);
      await Promise.all(batch.map(d => loadDistrict(d)));
    }
    loadingEl.classList.remove('active');
  } else {
    enabledAreas.delete(area);
    districts.forEach(d => unloadDistrict(d));
  }
}

// Build area panel from manifest
function buildAreaPanel() {
  const areaListEl = document.getElementById('area-list');

  // Group districts by area and count features
  const areaCounts = {};
  const areaDistricts = {};
  for (const [district, entry] of Object.entries(manifest)) {
    const area = entry.area;
    if (!areaCounts[area]) { areaCounts[area] = 0; areaDistricts[area] = 0; }
    areaCounts[area] += entry.features;
    areaDistricts[area]++;
  }

  // Sort areas: core London first, then outer
  const coreAreas = ['E', 'EC', 'N', 'NW', 'SE', 'SW', 'W', 'WC'];
  const outerAreas = ['BR', 'CR', 'DA', 'EN', 'HA', 'IG', 'KT', 'RM', 'SM', 'TW', 'UB'];
  const allAreas = [...coreAreas, ...outerAreas].filter(a => areaCounts[a]);

  for (const area of allAreas) {
    const item = document.createElement('div');
    item.className = 'area-item';
    const color = AREA_COLORS[area] || '#95a5a6';
    item.innerHTML = `
      <input type="checkbox" id="area-${area}" data-area="${area}">
      <div class="color-dot" style="background:${color}"></div>
      <label for="area-${area}">${area}</label>
      <span class="count">${areaDistricts[area]}d / ${areaCounts[area].toLocaleString()}</span>
    `;
    const cb = item.querySelector('input');
    cb.addEventListener('change', function() {
      toggleArea(this.dataset.area, this.checked);
    });
    areaListEl.appendChild(item);
  }
}

// Search
document.getElementById('search').addEventListener('input', function(e) {
  const query = e.target.value.toUpperCase().trim().replace(/\s/g, '');
  if (highlightedLayer) {
    const pc = highlightedLayer.feature.properties.postcodes;
    const d = pc.split(' ')[0];
    if (loadedDistricts[d]) loadedDistricts[d].resetStyle(highlightedLayer);
    highlightedLayer = null;
  }
  if (query.length < 4) return;

  function showMatch() {
    const m = allFeatureLookup[query];
    if (m) {
      highlightedLayer = m.layer;
      m.layer.setStyle({ weight: 4, color: '#000', fillColor: '#e74c3c', fillOpacity: 0.8 });
      m.layer.bringToFront();
      map.fitBounds(m.layer.getBounds(), { maxZoom: 18, padding: [50, 50] });
      const pc = m.feature.properties.postcodes;
      document.getElementById('info-postcode').innerHTML =
        pc;
      document.getElementById('info-detail').textContent = 'Area: ' + getArea(pc);
      document.getElementById('info-district').textContent = 'District: ' + pc.split(' ')[0];
    }
  }

  // Already loaded?
  if (allFeatureLookup[query]) { showMatch(); return; }

  // Find district and load it
  let district = '';
  for (let i = Math.min(query.length, 4); i >= 2; i--) {
    const candidate = query.slice(0, i);
    if (manifest[candidate]) { district = candidate; break; }
  }

  if (district) {
    // Enable the area checkbox too
    const area = manifest[district].area;
    const cb = document.getElementById('area-' + area);
    if (cb && !cb.checked) {
      cb.checked = true;
      enabledAreas.add(area);
    }
    loadDistrict(district).then(showMatch);
  }
});

// Init
fetch('manifest.json')
  .then(r => r.json())
  .then(data => {
    manifest = data;
    buildAreaPanel();
  });
</script>
</body>
</html>

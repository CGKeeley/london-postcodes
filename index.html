<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>London Postcode Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #map { height: 100%; width: 100%; }

  .info-panel {
    position: absolute; top: 10px; right: 10px; z-index: 1000;
    background: white; padding: 12px 16px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 220px;
    font-size: 14px; pointer-events: auto;
  }
  .info-panel h3 { margin: 0 0 2px 0; font-size: 20px; }
  .info-panel .detail { color: #666; font-size: 12px; margin: 1px 0; }
  .target-badge {
    display: inline-block; background: #e74c3c; color: white;
    font-size: 10px; padding: 1px 6px; border-radius: 3px; margin-left: 6px;
    vertical-align: middle;
  }

  .search-box {
    position: absolute; top: 10px; left: 55px; z-index: 1000;
  }
  .search-box input {
    padding: 8px 12px; border: 2px solid #ccc; border-radius: 6px;
    font-size: 14px; width: 220px; outline: none;
  }
  .search-box input:focus { border-color: #3498db; }

  .loading-indicator {
    position: absolute; bottom: 30px; right: 10px; z-index: 1000;
    background: white; padding: 6px 12px; border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-size: 12px;
    display: none;
  }
  .loading-indicator.active { display: block; }

  .stats {
    position: absolute; bottom: 30px; left: 10px; z-index: 1000;
    background: white; padding: 8px 12px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 11px;
    line-height: 1.5;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  <input type="text" id="search" placeholder="Search postcode (e.g. E17 9PB)">
</div>

<div class="info-panel" id="info">
  <h3 id="info-postcode">London Postcode Map</h3>
  <div class="detail" id="info-detail">Hover over a postcode unit</div>
  <div class="detail" id="info-district"></div>
</div>

<div class="loading-indicator" id="loading">Loading postcodes...</div>

<div class="stats" id="stats">
  <div>205,191 postcode units &middot; 331 districts</div>
  <div id="stats-loaded">Loaded: 0 districts</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const TARGET_POSTCODE = 'E17 9PB';

// Color by area code
const AREA_COLORS = {
  'E':  '#3498db', 'EC': '#2980b9',
  'N':  '#2ecc71', 'NW': '#27ae60',
  'SE': '#e74c3c', 'SW': '#c0392b',
  'W':  '#f39c12', 'WC': '#e67e22',
  'BR': '#8e44ad', 'CR': '#9b59b6',
  'DA': '#1abc9c', 'EN': '#16a085',
  'HA': '#d35400', 'IG': '#2c3e50',
  'KT': '#7f8c8d', 'RM': '#34495e',
  'SM': '#e84393', 'TW': '#00b894',
  'UB': '#6c5ce7'
};

// Sector sub-coloring: lighten/darken based on sector digit
function sectorShade(hexColor, sectorDigit) {
  const d = parseInt(sectorDigit) || 0;
  const factor = 0.7 + (d / 9) * 0.5; // range 0.7 to 1.2
  const r = parseInt(hexColor.slice(1,3), 16);
  const g = parseInt(hexColor.slice(3,5), 16);
  const b = parseInt(hexColor.slice(5,7), 16);
  const clamp = v => Math.min(255, Math.max(0, Math.round(v * factor)));
  return `rgb(${clamp(r)},${clamp(g)},${clamp(b)})`;
}

const canvasRenderer = L.canvas({ padding: 0.5 });
const map = L.map('map', { zoomControl: true, renderer: canvasRenderer, preferCanvas: true }).setView([51.505, -0.09], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors | Postcode boundaries: Open Government License v3.0',
  maxZoom: 19
}).addTo(map);

// State
let manifest = {};
let loadedDistricts = {};   // district -> L.geoJSON layer
let loadingDistricts = {};  // district -> Promise
let allFeatureLookup = {};  // postcode -> { feature, layer }
let highlightedLayer = null;
let loadedCount = 0;

const loadingEl = document.getElementById('loading');
const statsLoadedEl = document.getElementById('stats-loaded');

function getArea(postcode) {
  return postcode.replace(/[^A-Z]/g, '').replace(/^([A-Z]{1,2}).*/, '$1');
}

function getSector(postcode) {
  const parts = postcode.split(' ');
  return parts.length === 2 ? parts[1][0] : '0';
}

function defaultStyle(feature) {
  const pc = feature.properties.postcodes || '';
  const area = getArea(pc);
  const sector = getSector(pc);
  const baseColor = AREA_COLORS[area] || '#95a5a6';
  const isTarget = pc === TARGET_POSTCODE;
  return {
    fillColor: sectorShade(baseColor, sector),
    weight: isTarget ? 3 : 0.5,
    opacity: 1,
    color: isTarget ? '#000' : 'rgba(255,255,255,0.6)',
    fillOpacity: isTarget ? 0.75 : 0.4
  };
}

function highlightStyle() {
  return { weight: 2.5, color: '#2c3e50', fillOpacity: 0.7 };
}

function onEachFeature(feature, layer) {
  const pc = feature.properties.postcodes || '';
  allFeatureLookup[pc.toUpperCase().replace(/\s/g, '')] = { feature, layer };

  layer.on({
    mouseover: function(e) {
      e.target.setStyle(highlightStyle());
      e.target.bringToFront();
      const area = getArea(pc);
      const district = pc.split(' ')[0];
      document.getElementById('info-postcode').innerHTML =
        pc + (pc === TARGET_POSTCODE ? '<span class="target-badge">TARGET PROPERTY</span>' : '');
      document.getElementById('info-detail').textContent = 'Area: ' + area;
      document.getElementById('info-district').textContent = 'District: ' + district;
    },
    mouseout: function(e) {
      const parentLayer = loadedDistricts[e.target.feature.properties.postcodes.split(' ')[0]];
      if (parentLayer) parentLayer.resetStyle(e.target);
    },
    click: function(e) {
      map.fitBounds(e.target.getBounds(), { maxZoom: 18, padding: [50, 50] });
    }
  });
}

function loadDistrict(district) {
  if (loadedDistricts[district] || loadingDistricts[district]) return loadingDistricts[district] || Promise.resolve();

  const entry = manifest[district];
  if (!entry) return Promise.resolve();

  loadingDistricts[district] = fetch('data/' + entry.file)
    .then(r => r.json())
    .then(data => {
      const layer = L.geoJSON(data, {
        style: defaultStyle,
        onEachFeature: onEachFeature
      }).addTo(map);
      loadedDistricts[district] = layer;
      loadedCount++;
      statsLoadedEl.textContent = 'Loaded: ' + loadedCount + ' districts';
      delete loadingDistricts[district];
    })
    .catch(err => {
      console.error('Failed to load ' + district, err);
      delete loadingDistricts[district];
    });

  return loadingDistricts[district];
}

function unloadOffscreenDistricts() {
  const bounds = map.getBounds().pad(0.5); // keep a buffer
  for (const [district, layer] of Object.entries(loadedDistricts)) {
    const entry = manifest[district];
    if (!entry) continue;
    const dBounds = L.latLngBounds(entry.bounds);
    if (!bounds.intersects(dBounds)) {
      map.removeLayer(layer);
      // Remove from lookup
      layer.eachLayer(l => {
        const pc = l.feature.properties.postcodes;
        if (pc) delete allFeatureLookup[pc.toUpperCase().replace(/\s/g, '')];
      });
      delete loadedDistricts[district];
      loadedCount--;
      statsLoadedEl.textContent = 'Loaded: ' + loadedCount + ' districts';
    }
  }
}

function loadVisibleDistricts() {
  const bounds = map.getBounds();
  const zoom = map.getZoom();

  // Unload off-screen districts to keep memory down
  unloadOffscreenDistricts();

  // Only load individual postcode units when zoomed in enough
  if (zoom < 13) return;

  let toLoad = [];
  for (const [district, entry] of Object.entries(manifest)) {
    if (loadedDistricts[district]) continue;

    const dBounds = L.latLngBounds(entry.bounds);
    if (bounds.intersects(dBounds)) {
      toLoad.push(district);
    }
  }

  if (toLoad.length === 0) return;

  loadingEl.classList.add('active');

  // Load up to 5 at a time
  const batch = toLoad.slice(0, 5);
  Promise.all(batch.map(d => loadDistrict(d))).then(() => {
    loadingEl.classList.remove('active');
    if (toLoad.length > 5) {
      requestAnimationFrame(loadVisibleDistricts);
    }
  });
}

// Search
document.getElementById('search').addEventListener('input', function(e) {
  const query = e.target.value.toUpperCase().trim().replace(/\s/g, '');
  if (highlightedLayer) {
    const pc = highlightedLayer.feature.properties.postcodes;
    const district = pc.split(' ')[0];
    if (loadedDistricts[district]) loadedDistricts[district].resetStyle(highlightedLayer);
    highlightedLayer = null;
  }
  if (query.length < 4) return;

  // Check if already loaded
  const match = allFeatureLookup[query];
  if (match) {
    highlightedLayer = match.layer;
    match.layer.setStyle({ weight: 4, color: '#000', fillColor: '#e74c3c', fillOpacity: 0.8 });
    match.layer.bringToFront();
    map.fitBounds(match.layer.getBounds(), { maxZoom: 18, padding: [50, 50] });
    const pc = match.feature.properties.postcodes;
    document.getElementById('info-postcode').innerHTML =
      pc + (pc === TARGET_POSTCODE ? '<span class="target-badge">TARGET PROPERTY</span>' : '');
    return;
  }

  // Try to figure out district and load it
  // Postcodes: "E17 9PB" -> district "E17", or "SW1A 1AA" -> district "SW1A"
  let district = '';
  for (let i = Math.min(query.length, 4); i >= 2; i--) {
    const candidate = query.slice(0, i);
    if (manifest[candidate]) {
      district = candidate;
      break;
    }
  }

  if (district && !loadedDistricts[district]) {
    loadDistrict(district).then(() => {
      const m = allFeatureLookup[query];
      if (m) {
        highlightedLayer = m.layer;
        m.layer.setStyle({ weight: 4, color: '#000', fillColor: '#e74c3c', fillOpacity: 0.8 });
        m.layer.bringToFront();
        map.fitBounds(m.layer.getBounds(), { maxZoom: 18, padding: [50, 50] });
        const pc = m.feature.properties.postcodes;
        document.getElementById('info-postcode').innerHTML =
          pc + (pc === TARGET_POSTCODE ? '<span class="target-badge">TARGET PROPERTY</span>' : '');
      }
    });
  }
});

// Init
fetch('manifest.json')
  .then(r => r.json())
  .then(data => {
    manifest = data;
    map.on('moveend', loadVisibleDistricts);
    loadVisibleDistricts();
  });
</script>
</body>
</html>
